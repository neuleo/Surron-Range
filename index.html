<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surron Reichweitenrechner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #ffffff; border-radius: 50%; cursor: pointer; border: 4px solid #f97316; margin-top: -8px; }
        input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: #ffffff; border-radius: 50%; cursor: pointer; border: 4px solid #f97316; }
        .mode-label { transition: all 0.2s ease-in-out; }
        input:checked + .mode-label { background-color: #f97316; color: #ffffff; border-color: #f97316; }
        #map { height: 250px; border-radius: 1rem; z-index: 10; transition: height 0.3s ease-in-out; }
        #map.large { height: 500px; }
        @media (min-width: 1024px) {
            #map { height: 500px; }
            #map.large { height: 700px; }
        }
        .leaflet-control-attribution { font-size: 0.7rem !important; }
        .leaflet-control-attribution a { color: #f97316 !important; }
        .autocomplete-suggestions { max-height: 200px; overflow-y: auto; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 0.375rem; z-index: 999; }
        .suggestion-item { padding: 0.75rem 0.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a5568; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f97316; }
        .suggestion-item-label { flex-grow: 1; line-height: 1.2; }
        .suggestion-item-label .name { font-weight: 500; color: white; }
        .suggestion-item-label .address { font-size: 0.8rem; color: #a0aec0; }
        .save-place-btn { background: none; border: none; color: #cbd5e0; padding: 0.25rem; }
        .save-place-btn:hover { color: white; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { background: #4a5568; opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-start sm:items-center justify-center min-h-screen">

    <div class="w-full max-w-md md:max-w-2xl lg:max-w-7xl mx-auto bg-gray-800 rounded-3xl shadow-2xl my-8 sm:my-0 relative">
        
        <button id="menu-button" class="absolute top-4 right-4 z-30 p-2 rounded-full bg-gray-700/50 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500 lg:hidden">
            <svg id="menu-icon-open" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            <svg id="menu-icon-close" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>

        <!-- Mobile Layout -->
        <div class="lg:hidden">
            <!-- ===== Calculator Page ===== -->
            <div id="calculator-page">
                <div class="bg-gray-700 rounded-t-3xl"><img src="https://placehold.co/600x300/1f2937/ffffff?text=SUR-RON" alt="Surron E-Bike" class="w-full h-auto object-cover rounded-t-3xl" onerror="this.onerror=null;this.src='https://placehold.co/600x300/1f2937/ffffff?text=Surron+Bild+fehlt';"></div>
                <div class="p-6 md:p-8 space-y-6">
                    <div class="text-center"><h1 class="text-2xl font-bold text-white">Reichweitenrechner</h1><p class="text-gray-400">Gib deinen aktuellen Akkustand an.</p></div>
                    <div class="text-center"><div class="flex items-center justify-center space-x-4"><button id="minus-btn" class="w-12 h-12 bg-gray-700 rounded-full text-3xl font-bold text-white hover:bg-gray-600 active:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">-</button><span id="battery-level-display" class="text-5xl font-black text-orange-500 w-32 text-center">100%</span><button id="plus-btn" class="w-12 h-12 bg-gray-700 rounded-full text-3xl font-bold text-white hover:bg-gray-600 active:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">+</button></div></div>
                    <div><input type="range" id="battery-slider" min="0" max="100" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg accent-orange-500"></div>
                    <div><label class="block text-sm font-medium text-gray-400 mb-2 text-center">Fahrmodus</label><div class="flex justify-center bg-gray-700 rounded-xl p-1"><div class="w-1/2"><input type="radio" name="mode" id="mode-sport" value="sport" class="hidden" checked><label for="mode-sport" class="mode-label text-center block w-full cursor-pointer rounded-lg border border-transparent p-2 font-semibold">Sport</label></div><div class="w-1/2"><input type="radio" name="mode" id="mode-eco" value="eco" class="hidden"><label for="mode-eco" class="mode-label text-center block w-full cursor-pointer rounded-lg border border-transparent p-2 font-semibold">Eco</label></div></div></div>
                    <div class="pt-2"><label for="capacity-toggle" class="flex items-center justify-center cursor-pointer"><div class="relative"><input type="checkbox" id="capacity-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-700 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-500/50 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></div><span class="ml-3 text-sm font-medium text-gray-400">Leistungsdrossel (90% nutzbar)</span></label></div>
                    <div class="bg-gray-900 rounded-xl p-6 text-center"><p class="text-gray-400 text-sm uppercase font-semibold">Verbleibende Reichweite</p><p class="text-4xl md:text-5xl font-extrabold text-white"><span id="range-output">44.7</span> km</p></div>
                </div>
            </div>

            <!-- ===== Route Page ===== -->
            <div id="route-page" class="hidden">
                <div class="p-6 md:p-8">
                    <div class="space-y-4">
                        <div class="text-center"><h1 class="text-2xl font-bold text-white">Routenplaner</h1><p class="text-gray-400">Plane eine Tour mit mehreren Stops.</p></div>
                        <div id="stops-container" class="space-y-4"></div>
                        <button id="add-stop-btn" class="w-full border-2 border-dashed border-gray-600 hover:border-orange-600 text-gray-400 font-bold py-2 px-4 rounded-lg focus:outline-none">+ Stop hinzufügen</button>
                        <div class="flex items-center space-x-2">
                            <button id="calculate-route-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">Route berechnen</button>
                            <button id="toggle-map-size-btn" class="flex-shrink-0 p-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" title="Karte vergrößern/verkleinern">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                                </svg>
                            </button>
                        </div>
                        <div id="map"></div>
                        <div id="route-results"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Layout -->
        <div class="hidden lg:flex p-8 space-x-8">
            <!-- Route Planner Column -->
            <div class="w-1/2 space-y-4">
                <div class="text-center"><h1 class="text-2xl font-bold text-white">Routenplaner</h1><p class="text-gray-400">Plane eine Tour mit mehreren Stops.</p></div>
                <div id="stops-container-desktop" class="space-y-4"></div>
                <button id="add-stop-btn-desktop" class="w-full border-2 border-dashed border-gray-600 hover:border-orange-600 text-gray-400 font-bold py-2 px-4 rounded-lg focus:outline-none">+ Stop hinzufügen</button>
                <button id="calculate-route-btn-desktop" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">Route berechnen</button>
                <div id="route-results-desktop"></div>
            </div>
            <!-- Right Column -->
            <div class="w-1/2 flex flex-col space-y-8">
                <!-- Calculator Controls -->
                <div class="space-y-6">
                    <div class="text-center"><h1 class="text-2xl font-bold text-white">Reichweitenrechner</h1><p class="text-gray-400">Gib deinen aktuellen Akkustand an.</p></div>
                    <div class="text-center"><div class="flex items-center justify-center space-x-4"><button id="minus-btn-desktop" class="w-12 h-12 bg-gray-700 rounded-full text-3xl font-bold text-white hover:bg-gray-600 active:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">-</button><span id="battery-level-display-desktop" class="text-5xl font-black text-orange-500 w-32 text-center">100%</span><button id="plus-btn-desktop" class="w-12 h-12 bg-gray-700 rounded-full text-3xl font-bold text-white hover:bg-gray-600 active:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">+</button></div></div>
                    <div><input type="range" id="battery-slider-desktop" min="0" max="100" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg accent-orange-500"></div>
                    <div><label class="block text-sm font-medium text-gray-400 mb-2 text-center">Fahrmodus</label><div class="flex justify-center bg-gray-700 rounded-xl p-1"><div class="w-1/2"><input type="radio" name="mode-desktop" id="mode-sport-desktop" value="sport" class="hidden" checked><label for="mode-sport-desktop" class="mode-label text-center block w-full cursor-pointer rounded-lg border border-transparent p-2 font-semibold">Sport</label></div><div class="w-1/2"><input type="radio" name="mode-desktop" id="mode-eco-desktop" value="eco" class="hidden"><label for="mode-eco-desktop" class="mode-label text-center block w-full cursor-pointer rounded-lg border border-transparent p-2 font-semibold">Eco</label></div></div></div>
                    <div class="pt-2"><label for="capacity-toggle-desktop" class="flex items-center justify-center cursor-pointer"><div class="relative"><input type="checkbox" id="capacity-toggle-desktop" class="sr-only peer"><div class="w-11 h-6 bg-gray-700 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-500/50 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></div><span class="ml-3 text-sm font-medium text-gray-400">Leistungsdrossel (90% nutzbar)</span></label></div>
                    <div class="bg-gray-900 rounded-xl p-6 text-center"><p class="text-gray-400 text-sm uppercase font-semibold">Verbleibende Reichweite</p><p class="text-4xl md:text-5xl font-extrabold text-white"><span id="range-output-desktop">44.7</span> km</p></div>
                </div>
                <!-- Map -->
                <div class="flex-grow">
                    <div id="map-desktop" class="h-full min-h-[400px] rounded-2xl bg-gray-700"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Place Modal -->
    <div id="save-place-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-11/12 max-w-sm space-y-4">
            <h2 class="text-xl font-bold">Ort speichern</h2>
            <p id="save-place-label" class="text-gray-400"></p>
            <div>
                <label for="place-name-input" class="block text-sm font-medium text-gray-400">Name des Ortes</label>
                <input type="text" id="place-name-input" class="mt-1 block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-save-btn" class="px-4 py-2 rounded-md text-white hover:bg-gray-700">Abbrechen</button>
                <button id="confirm-save-btn" class="px-4 py-2 rounded-md bg-orange-600 text-white hover:bg-orange-700">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // ===== API Keys & Constants =====
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImIzNTk3Mjc5MTZmNTQyZTdiNWI2MmMxOTJkZDMxNDQ0IiwiaCI6Im11cm11cjY0In0=';
        const sportKmPerPercent = 26.4 / 59;
        const ecoFactor = 1.3; // Data-driven factor based on provided Eco rides
        const ecoKmPerPercent = sportKmPerPercent * ecoFactor;

        // Neue Logik für Höhenmeter basierend auf sur_ron_data.csv
        const sportPercentPerKm = 1 / sportKmPerPercent;
        const sportPercentPerMeterUp = 0.0205; // % pro Höhenmeter bergauf
        const sportPercentPerMeterDown = -0.0203; // % pro Höhenmeter bergab (Rekuperation)
        
        const ecoPercentPerKm = sportPercentPerKm / ecoFactor;
        const ecoPercentPerMeterUp = sportPercentPerMeterUp / ecoFactor;
        const ecoPercentPerMeterDown = sportPercentPerMeterDown / ecoFactor;

        // ===== DOM Elements =====
        const batterySlider = document.getElementById('battery-slider');
        const batteryLevelDisplay = document.getElementById('battery-level-display');
        const rangeOutput = document.getElementById('range-output');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const capacityToggle = document.getElementById('capacity-toggle');
        const plusBtn = document.getElementById('plus-btn');
        const minusBtn = document.getElementById('minus-btn');
        const menuButton = document.getElementById('menu-button');
        const menuIconOpen = document.getElementById('menu-icon-open');
        const menuIconClose = document.getElementById('menu-icon-close');
        const calculatorPage = document.getElementById('calculator-page');
        const routePage = document.getElementById('route-page');
        const calculateRouteBtn = document.getElementById('calculate-route-btn');
        const stopsContainer = document.getElementById('stops-container');
        const addStopBtn = document.getElementById('add-stop-btn');
        const routeResults = document.getElementById('route-results');
        const savePlaceModal = document.getElementById('save-place-modal');
        const savePlaceLabel = document.getElementById('save-place-label');
        const placeNameInput = document.getElementById('place-name-input');
        const cancelSaveBtn = document.getElementById('cancel-save-btn');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');
        const toggleMapSizeBtn = document.getElementById('toggle-map-size-btn');

        // Desktop Elements
        const batterySliderDesktop = document.getElementById('battery-slider-desktop');
        const batteryLevelDisplayDesktop = document.getElementById('battery-level-display-desktop');
        const rangeOutputDesktop = document.getElementById('range-output-desktop');
        const modeRadiosDesktop = document.querySelectorAll('input[name="mode-desktop"]');
        const capacityToggleDesktop = document.getElementById('capacity-toggle-desktop');
        const plusBtnDesktop = document.getElementById('plus-btn-desktop');
        const minusBtnDesktop = document.getElementById('minus-btn-desktop');
        const calculateRouteBtnDesktop = document.getElementById('calculate-route-btn-desktop');
        const stopsContainerDesktop = document.getElementById('stops-container-desktop');
        const addStopBtnDesktop = document.getElementById('add-stop-btn-desktop');
        const routeResultsDesktop = document.getElementById('route-results-desktop');

        // ===== State & Map Variables =====
        let map, routeLayer, sortable, desktopMap, desktopRouteLayer, desktopSortable;
        let waypoints = [ { label: '', coords: null }, { label: '', coords: null } ];
        let placeToSave = {};

        // ===== Utility Functions =====
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };

        // ===== State Management (localStorage) =====
        function saveState() { 
            const state = { 
                battery: batterySlider.value, 
                mode: document.querySelector('input[name="mode"]:checked').value, 
                throttled: capacityToggle.checked 
            }; 
            localStorage.setItem('surRonRangeState', JSON.stringify(state)); 
        }
        function loadState() { 
            const savedState = localStorage.getItem('surRonRangeState'); 
            if (savedState) { 
                const state = JSON.parse(savedState); 
                batterySlider.value = state.battery; 
                batterySliderDesktop.value = state.battery;
                capacityToggle.checked = state.throttled; 
                capacityToggleDesktop.checked = state.throttled;
                document.querySelector(`input[name="mode"][value="${state.mode}"]`).checked = true; 
                document.querySelector(`input[name="mode-desktop"][value="${state.mode}"]`).checked = true;
            } 
        }
        function getSavedPlaces() { const places = localStorage.getItem('surRonSavedPlaces'); return places ? JSON.parse(places) : []; }
        
        function openSavePlaceModal(label, coords) {
            placeToSave = { label, coords };
            savePlaceLabel.textContent = label;
            placeNameInput.value = '';
            savePlaceModal.classList.remove('hidden');
            placeNameInput.focus();
        }

        function closeSavePlaceModal() {
            savePlaceModal.classList.add('hidden');
        }

        function confirmSavePlace() {
            const name = placeNameInput.value;
            if (name && placeToSave.label) {
                const places = getSavedPlaces();
                const newPlace = { id: Date.now(), name, label: placeToSave.label, coords: placeToSave.coords };
                places.push(newPlace);
                localStorage.setItem('surRonSavedPlaces', JSON.stringify(places));
                closeSavePlaceModal();
            }
        }

        // ===== Core Calculator Logic =====
        function calculateRange() { 
            const actualBatteryLevel = parseInt(batterySlider.value); 
            const selectedMode = document.querySelector('input[name="mode"]:checked').value; 
            const isThrottledMode = capacityToggle.checked; 
            let usableBatteryLevel = isThrottledMode ? Math.max(0, actualBatteryLevel - 10) : actualBatteryLevel; 
            let remainingRange = selectedMode === 'sport' ? usableBatteryLevel * sportKmPerPercent : usableBatteryLevel * ecoKmPerPercent; 
            batteryLevelDisplay.textContent = `${actualBatteryLevel}%`; 
            rangeOutput.textContent = remainingRange.toFixed(1); 
        }
        function updateAndSave() { calculateRange(); saveState(); }

        function calculateRangeDesktop() { 
            const actualBatteryLevel = parseInt(batterySliderDesktop.value); 
            const selectedMode = document.querySelector('input[name="mode-desktop"]:checked').value; 
            const isThrottledMode = capacityToggleDesktop.checked; 
            let usableBatteryLevel = isThrottledMode ? Math.max(0, actualBatteryLevel - 10) : actualBatteryLevel; 
            let remainingRange = selectedMode === 'sport' ? usableBatteryLevel * sportKmPerPercent : usableBatteryLevel * ecoKmPerPercent; 
            batteryLevelDisplayDesktop.textContent = `${actualBatteryLevel}%`; 
            rangeOutputDesktop.textContent = remainingRange.toFixed(1); 
        }
        function updateAndSaveDesktop() { calculateRangeDesktop(); saveState(); }

        // ===== Map & Route Logic =====
        function initMap(mapId = 'map') {
            let mapInstance = L.map(mapId).setView([51.1657, 10.4515], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(mapInstance);
            return mapInstance;
        }
        
        function setupMapInteractions(mapInstance) {
            let longPressTimeout;
            mapInstance.on('mousedown', function (e) {
                longPressTimeout = setTimeout(async () => {
                    mapInstance.closePopup();
                    const { lat, lng } = e.latlng;
                    
                    try {
                        const response = await fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lon=${lng}&point.lat=${lat}&size=1`);
                        const data = await response.json();
                        
                        if (data.features && data.features.length > 0) {
                            const place = data.features[0];
                            const newWaypoint = {
                                label: place.properties.label,
                                coords: place.geometry.coordinates
                            };

                            const emptyStopIndex = waypoints.findIndex(w => !w.coords);
                            
                            if (emptyStopIndex !== -1) {
                                waypoints[emptyStopIndex] = newWaypoint;
                            } else {
                                waypoints.splice(waypoints.length - 1, 0, newWaypoint);
                            }
                            renderStops();
                            if(window.innerWidth >= 1024) renderStopsDesktop();
                            
                            L.popup()
                             .setLatLng(e.latlng)
                             .setContent(`<b>${place.properties.name || 'Punkt'}</b><br>wurde zur Route hinzugefügt.`)
                             .openOn(mapInstance);

                        } else {
                            L.popup()
                             .setLatLng(e.latlng)
                             .setContent("Ort konnte nicht gefunden werden.")
                             .openOn(mapInstance);
                        }
                    } catch (error) {
                        console.error("Fehler beim Reverse Geocoding:", error);
                        L.popup()
                             .setLatLng(e.latlng)
                             .setContent("Fehler bei der Adresssuche.")
                             .openOn(mapInstance);
                    }
                }, 750);
            });

            mapInstance.on('mouseup', function () { clearTimeout(longPressTimeout); });
            mapInstance.on('movestart', function () { clearTimeout(longPressTimeout); });
        }

        function renderStopsGeneric(stopsContainerEl, sortableInstance, isDesktop) {
            if (sortableInstance) sortableInstance.destroy();
            stopsContainerEl.innerHTML = '';
            waypoints.forEach((waypoint, index) => {
                const isStart = index === 0;
                const isEnd = index === waypoints.length - 1;
                let labelText = isStart ? 'Start' : (isEnd ? 'Ziel' : `Stop ${index}`);

                const stopDiv = document.createElement('div');
                stopDiv.className = 'stop-item bg-gray-700/50 p-2 rounded-md flex items-center space-x-3';
                stopDiv.innerHTML = `
                    <svg class="drag-handle h-6 w-6 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><circle cx="7" cy="5" r="1.5" /><circle cx="13" cy="5" r="1.5" /><circle cx="7" cy="10" r="1.5" /><circle cx="13" cy="10" r="1.5" /><circle cx="7" cy="15" r="1.5" /><circle cx="13" cy="15" r="1.5" /></svg>
                    <div class="flex-grow">
                        <label class="text-sm font-medium text-gray-400">${labelText}</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <div class="relative flex-grow">
                                <input type="text" data-index="${index}" class="stop-input block w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2 focus:ring-orange-500 focus:border-orange-500" autocomplete="off" value="${waypoint.label}">
                                <div class="autocomplete-suggestions absolute w-full mt-1 z-20"></div>
                            </div>
                            ${!isStart ? `<button data-index="${index}" class="remove-stop-btn p-2 bg-gray-700 rounded-md hover:bg-red-600" title="Stop entfernen">&times;</button>` : `<button class="current-loc-btn p-2 bg-gray-700 rounded-md hover:bg-orange-600" title="Aktuellen Standort verwenden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></button>`}
                        </div>
                    </div>
                `;
                stopsContainerEl.appendChild(stopDiv);
            });
            attachStopListeners(isDesktop);
            if(isDesktop) {
                desktopSortable = new Sortable(stopsContainerDesktop, { animation: 150, handle: '.drag-handle', delay: 200, delayOnTouchOnly: true, onEnd: (evt) => { const movedItem = waypoints.splice(evt.oldIndex, 1)[0]; waypoints.splice(evt.newIndex, 0, movedItem); renderStopsDesktop(); } });
            } else {
                sortable = new Sortable(stopsContainer, { animation: 150, handle: '.drag-handle', delay: 200, delayOnTouchOnly: true, onEnd: (evt) => { const movedItem = waypoints.splice(evt.oldIndex, 1)[0]; waypoints.splice(evt.newIndex, 0, movedItem); renderStops(); } });
            }
        }

        function renderStops() { renderStopsGeneric(stopsContainer, sortable, false); }
        function renderStopsDesktop() { renderStopsGeneric(stopsContainerDesktop, desktopSortable, true); }

        function attachStopListeners(isDesktop) {
            const selector = isDesktop ? '#stops-container-desktop' : '#stops-container';
            document.querySelector(selector).querySelectorAll('.stop-input').forEach(input => {
                input.addEventListener('input', debounce(handleAutocomplete, 150));
                input.addEventListener('focus', handleAutocomplete);
            });
            document.querySelector(selector).querySelectorAll('.remove-stop-btn').forEach(btn => { btn.addEventListener('click', (e) => { waypoints.splice(e.currentTarget.dataset.index, 1); renderStops(); if(isDesktop) renderStopsDesktop(); }); });
            document.querySelector(selector).querySelectorAll('.current-loc-btn').forEach(btn => { btn.addEventListener('click', getCurrentLocation); });
        }

        function addStop() { waypoints.push({ label: '', coords: null }); renderStops(); }
        function addStopDesktop() { waypoints.push({ label: '', coords: null }); renderStopsDesktop(); }

        async function handleAutocomplete(e) {
            const input = e.target;
            const suggestionsContainer = input.nextElementSibling;
            const text = input.value.trim();
            const coordRegex = /^\s*(-?\d{1,3}(?:\.\d+)?)\s*,\s*(-?\d{1,3}(?:\.\d+)?)\s*$/;
            const coordMatch = text.match(coordRegex);
            if (coordMatch) { const lat = parseFloat(coordMatch[1]); const lon = parseFloat(coordMatch[2]); if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) { suggestionsContainer.innerHTML = ''; const coords = [lon, lat]; const response = await fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lon=${lon}&point.lat=${lat}`); const data = await response.json(); if (data.features && data.features.length > 0) { const label = data.features[0].properties.label; input.value = label; waypoints[input.dataset.index] = { label, coords }; } return; } }
            const searchText = text.toLowerCase();
            suggestionsContainer.innerHTML = '';
            const savedPlaces = getSavedPlaces();
            const filteredSavedPlaces = savedPlaces.filter(p => p.name.toLowerCase().includes(searchText) || p.label.toLowerCase().includes(searchText));
            let suggestions = filteredSavedPlaces.map(p => ({ ...p, isSaved: true }));
            if (text.length >= 3) { const response = await fetch(`https://api.openrouteservice.org/geocode/autocomplete?api_key=${ORS_API_KEY}&text=${text}&layers=venue,address,street`); const data = await response.json(); const apiSuggestions = data.features.map(f => ({ ...f, isSaved: false })); suggestions = suggestions.concat(apiSuggestions); }
            showSuggestions(suggestions, suggestionsContainer, input);
        }

        function showSuggestions(features, container, input) {
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                const isSaved = feature.isSaved;
                const label = isSaved ? feature.label : feature.properties.label;
                const name = isSaved ? feature.name : null;
                const coords = isSaved ? feature.coords : feature.geometry.coordinates;
                item.dataset.label = label;
                item.dataset.coords = JSON.stringify(coords);
                const labelDiv = document.createElement('div');
                labelDiv.className = 'suggestion-item-label';
                if (isSaved) { labelDiv.innerHTML = `<div class="name">⭐ ${name}</div><div class="address">${label}</div>`; } else { labelDiv.textContent = label; }
                item.appendChild(labelDiv);
                if (!isSaved) { const saveBtn = document.createElement('button'); saveBtn.className = 'save-place-btn'; saveBtn.innerHTML = '&#11088;'; saveBtn.title = "Ort speichern"; item.appendChild(saveBtn); }
                fragment.appendChild(item);
            });
            container.appendChild(fragment);

            const selectEvent = ('ontouchstart' in window) ? 'touchstart' : 'mousedown';
            container.addEventListener(selectEvent, (e) => {
                e.preventDefault();
                const targetItem = e.target.closest('.suggestion-item');
                if (!targetItem) return;

                if (e.target.closest('.save-place-btn')) {
                    e.stopPropagation();
                    openSavePlaceModal(targetItem.dataset.label, JSON.parse(targetItem.dataset.coords));
                    return;
                }
                
                input.value = targetItem.dataset.label;
                waypoints[input.dataset.index] = { label: targetItem.dataset.label, coords: JSON.parse(targetItem.dataset.coords) };
                container.innerHTML = '';
            });
        }

        async function getCurrentLocation() { if (!navigator.geolocation) { alert("Geolocation wird von deinem Browser nicht unterstützt."); return; } navigator.geolocation.getCurrentPosition(async (position) => { const { latitude, longitude } = position.coords; const response = await fetch(`https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lon=${longitude}&point.lat=${latitude}`); const data = await response.json(); if (data.features && data.features.length > 0) { const place = data.features[0]; waypoints[0] = { label: place.properties.label, coords: place.geometry.coordinates }; renderStops(); if(window.innerWidth >= 1024) renderStopsDesktop(); } else { alert("Dein Standort konnte nicht in eine Adresse umgewandelt werden."); } }, () => alert("Standortzugriff verweigert.")); }

        async function calculateRouteGeneric(btn, resultsContainer, mapInstance, routeLayerInstance, isDesktop) {
            const filledWaypoints = waypoints.filter(w => w.coords);
            if (filledWaypoints.length < 2) {
                alert("Bitte mindestens Start und Ziel angeben.");
                return;
            }
            btn.disabled = true;
            btn.textContent = "Berechne...";
            try {
                const coords = filledWaypoints.map(w => w.coords);
                const response = await fetch(`https://api.openrouteservice.org/v2/directions/cycling-mountain/geojson`, {
                    method: 'POST',
                    headers: { 'Authorization': ORS_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coordinates: coords, elevation: true }) // Höhenmeter anfordern
                });
                if (!response.ok) throw new Error('Fehler bei der Routenberechnung.');
                const data = await response.json();
                const route = data.features[0];
                
                const routeCoords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                if (routeLayerInstance) mapInstance.removeLayer(routeLayerInstance);
                
                if(isDesktop) {
                    desktopRouteLayer = L.polyline(routeCoords, { color: '#f97316' }).addTo(mapInstance);
                    mapInstance.fitBounds(desktopRouteLayer.getBounds());
                } else {
                    routeLayer = L.polyline(routeCoords, { color: '#f97316' }).addTo(mapInstance);
                    mapInstance.fitBounds(routeLayer.getBounds());
                }
                
                let sportBattery = parseInt(isDesktop ? batterySliderDesktop.value : batterySlider.value);
                let ecoBattery = parseInt(isDesktop ? batterySliderDesktop.value : batterySlider.value);
                let resultsHtml = '';

                route.properties.segments.forEach((segment, i) => {
                    const distanceKm = segment.distance / 1000;
                    const ascent = segment.ascent || 0;
                    const descent = segment.descent || 0;

                    const sportNeeded = (distanceKm * sportPercentPerKm) + (ascent * sportPercentPerMeterUp) + (descent * sportPercentPerMeterDown);
                    const ecoNeeded = (distanceKm * ecoPercentPerKm) + (ascent * ecoPercentPerMeterUp) + (descent * ecoPercentPerMeterDown);
                    
                    sportBattery -= sportNeeded;
                    ecoBattery -= ecoNeeded;

                    const destinationStop = filledWaypoints[i + 1];

                    resultsHtml += `
                        <div class="p-3 bg-gray-700 rounded-lg">
                            <p class="font-bold">Ankunft bei: ${destinationStop.label.substring(0, 30)}...</p>
                            <p class="text-sm text-gray-400">Etappe: ${distanceKm.toFixed(1)} km, ${ascent.toFixed(0)}m <span class="text-green-400 font-semibold">▲</span>, ${descent.toFixed(0)}m <span class="text-red-400 font-semibold">▼</span></p>
                            <div class="grid grid-cols-2 gap-2 pt-1 text-center">
                                <div>
                                    <p class="text-xs text-gray-400">Ankunft (Sport)</p>
                                    <p class="font-bold ${sportBattery < 10 ? 'text-red-500' : ''}">${sportBattery.toFixed(0)}%</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400">Ankunft (Eco)</p>
                                    <p class="font-bold ${ecoBattery < 10 ? 'text-red-500' : ''}">${ecoBattery.toFixed(0)}%</p>
                                </div>
                            </div>
                        </div>`;
                });
                resultsContainer.innerHTML = `<div class="space-y-3">${resultsHtml}</div>`;

                const navButton = document.createElement('button');
                navButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -ml-1 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 16.5V3a1 1 0 00-.106-.447z" /></svg>Navigation starten`;
                navButton.className = 'w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500 flex items-center justify-center';
                navButton.onclick = () => {
                    const waypointsForNav = JSON.parse(JSON.stringify(filledWaypoints));
                    const origin = `${waypointsForNav[0].coords[1]},${waypointsForNav[0].coords[0]}`;
                    const destination = `${waypointsForNav[waypointsForNav.length - 1].coords[1]},${waypointsForNav[waypointsForNav.length - 1].coords[0]}`;
                    const waypointsString = waypointsForNav.slice(1, -1).map(w => `${w.coords[1]},${w.coords[0]}`).join('|');
                    
                    let navUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
                    if (waypointsString) {
                        navUrl += `&waypoints=${waypointsString}`;
                    }
                    navUrl += `&travelmode=bicycling`;

                    window.open(navUrl, '_blank');
                };
                resultsContainer.appendChild(navButton);

            } catch (error) {
                console.error(error);
                alert(error.message);
                resultsContainer.innerHTML = `<p class="text-red-500 text-center">Routenberechnung fehlgeschlagen.</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "Route berechnen";
            }
        }
        async function calculateRoute() { await calculateRouteGeneric(calculateRouteBtn, routeResults, map, routeLayer, false); }
        async function calculateRouteDesktop() { await calculateRouteGeneric(calculateRouteBtnDesktop, routeResultsDesktop, desktopMap, desktopRouteLayer, true); }

        // ===== Event Listeners =====
        batterySlider.addEventListener('input', updateAndSave);
        capacityToggle.addEventListener('change', updateAndSave);
        modeRadios.forEach(radio => radio.addEventListener('change', updateAndSave));
        plusBtn.addEventListener('click', () => { if (parseInt(batterySlider.value) < 100) { batterySlider.value = parseInt(batterySlider.value) + 1; batterySlider.dispatchEvent(new Event('input')); } });
        minusBtn.addEventListener('click', () => { if (parseInt(batterySlider.value) > 0) { batterySlider.value = parseInt(batterySlider.value) - 1; batterySlider.dispatchEvent(new Event('input')); } });
        
        batterySliderDesktop.addEventListener('input', updateAndSaveDesktop);
        capacityToggleDesktop.addEventListener('change', updateAndSaveDesktop);
        modeRadiosDesktop.forEach(radio => radio.addEventListener('change', updateAndSaveDesktop));
        plusBtnDesktop.addEventListener('click', () => { if (parseInt(batterySliderDesktop.value) < 100) { batterySliderDesktop.value = parseInt(batterySliderDesktop.value) + 1; batterySliderDesktop.dispatchEvent(new Event('input')); } });
        minusBtnDesktop.addEventListener('click', () => { if (parseInt(batterySliderDesktop.value) > 0) { batterySliderDesktop.value = parseInt(batterySliderDesktop.value) - 1; batterySliderDesktop.dispatchEvent(new Event('input')); } });

        menuButton.addEventListener('click', () => { 
            const isRoutePageOpen = !routePage.classList.contains('hidden'); 
            if (isRoutePageOpen) { 
                routePage.classList.add('hidden'); 
                calculatorPage.classList.remove('hidden'); 
                menuIconOpen.classList.remove('hidden'); 
                menuIconClose.classList.add('hidden'); 
            } else { 
                calculatorPage.classList.add('hidden'); 
                routePage.classList.remove('hidden'); 
                menuIconOpen.classList.add('hidden'); 
                menuIconClose.classList.remove('hidden'); 
                if(!map) {
                    map = initMap('map');
                    setupMapInteractions(map);
                }
                renderStops(); 
            } 
        });
        addStopBtn.addEventListener('click', addStop);
        addStopBtnDesktop.addEventListener('click', addStopDesktop);
        calculateRouteBtn.addEventListener('click', calculateRoute);
        calculateRouteBtnDesktop.addEventListener('click', calculateRouteDesktop);
        confirmSaveBtn.addEventListener('click', confirmSavePlace);
        cancelSaveBtn.addEventListener('click', closeSavePlaceModal);

        toggleMapSizeBtn.addEventListener('click', () => {
            const mapDiv = document.getElementById('map');
            
            const onTransitionEnd = () => {
                if (map) {
                    map.invalidateSize();
                }
                mapDiv.removeEventListener('transitionend', onTransitionEnd);
            };
            mapDiv.addEventListener('transitionend', onTransitionEnd);

            mapDiv.classList.toggle('large');
        });

        // ===== Initial Load =====
        document.addEventListener('DOMContentLoaded', () => { 
            loadState(); 
            calculateRange(); 
            saveState(); 
            if (window.innerWidth >= 1024) {
                desktopMap = initMap('map-desktop');
                setupMapInteractions(desktopMap);
                renderStopsDesktop();
                calculateRangeDesktop();
            }
        });
    </script>

</body>
</html>
